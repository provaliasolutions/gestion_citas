<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Citas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    .calendar-day { transition: all 0.2s ease; }
    .calendar-day.available:not(.selected):hover { background-color: #eef2ff; color: #4f46e5; }
    .calendar-day.available { cursor: pointer; border-bottom: 2px solid #6366f1; }
    .calendar-day.selected { background-color: #4f46e5; color: white; font-weight: bold; }
    .calendar-day.disabled { color: #d1d5db; cursor: not-allowed; }
    .time-slot { transition: all 0.2s ease; }
    .time-slot.selected { background-color: #4f46e5; color: white; font-weight: bold; }
    .admin-tab-btn.active { background-color: #eef2ff; color: #4338ca; font-semibold; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="min-h-screen flex flex-col items-center p-4 w-full">
    <nav id="main-nav" class="w-full max-w-4xl mx-auto py-4 hidden"></nav>
    <nav id="admin-nav" class="w-full max-w-6xl mx-auto py-4 hidden"></nav>

    <div id="view-container" class="w-full flex-grow flex flex-col items-center justify-center">
    <!-- VISTAS DE CLIENTE -->
    <div id="login-view" class="w-full max-w-md fade-in"></div>
    <div id="services-view" class="w-full max-w-4xl fade-in hidden"></div>
    <div id="calendar-view" class="w-full max-w-4xl fade-in hidden"></div>
    <div id="confirmation-view" class="w-full max-w-lg fade-in hidden"></div>
    <div id="my-appointments-view" class="w-full max-w-3xl fade-in hidden"></div>
    <!-- VISTA DE ADMINISTRADOR -->
    <div id="admin-view" class="w-full max-w-6xl fade-in hidden"></div>
    </div>
    </div>
    
    <!-- Modales -->
    <div id="icon-picker-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
    <h3 class="text-xl font-bold">Seleccionar Icono</h3>
    <button id="close-icon-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
    </div>
    <div id="icon-picker-grid" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-4"></div>
    </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-xl">
    <h3 id="confirm-modal-title" class="text-lg font-bold mb-2">Confirmar Acción</h3>
    <p id="confirm-modal-text" class="text-gray-600 mb-6">¿Estás seguro?</p>
    <div class="flex gap-4">
    <button id="confirm-modal-cancel" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
    <button id="confirm-modal-ok" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Confirmar</button>
    </div>
    </div>
    </div>


    <script type="module">
    // Importa las funciones que necesitas de los SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, addDoc, setDoc, deleteDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

    // --- CONFIGURACIÓN DE FIREBASE ---
    // IMPORTANTE: Reemplaza esto con la configuración de tu propio proyecto de Firebase
    const firebaseConfig = {
		  apiKey: "AIzaSyAstnTL-hKDTdghCcsmQ6oBV17b-DU8Bus",
		  authDomain: "gestioncitas-ac58e.firebaseapp.com",
		  projectId: "gestioncitas-ac58e",
		  storageBucket: "gestioncitas-ac58e.appspot.com",
		  messagingSenderId: "50904744334",
		  appId: "1:50904744334:web:91e6fc26930488193b64df",
		  measurementId: "G-T2LCG5923R"
		};

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- RENDERIZADO INICIAL ---
    document.addEventListener('DOMContentLoaded', () => {
		  try {
			initializeAppState();
		  } catch (e) {
			console.error("Error inicializando Firebase:", e);
			// Mostrar login aunque Firebase no funcione
			showView('login');
			renderLogin();
		  }
		});

    // --- ESTADO GLOBAL DE LA APLICACIÓN ---
    const PREDEFINED_ICONS = [ 'fa-solid fa-person-running', 'fa-solid fa-shoe-prints', 'fa-solid fa-tooth', 'fa-solid fa-gavel', 'fa-solid fa-car-wrench', 'fa-solid fa-spa', 'fa-solid fa-cut', 'fa-solid fa-paint-brush', 'fa-solid fa-briefcase', 'fa-solid fa-user-doctor', 'fa-solid fa-heart-pulse', 'fa-solid fa-bone', 'fa-solid fa-brain', 'fa-solid fa-pills', 'fa-solid fa-dog', 'fa-solid fa-cat', 'fa-solid fa-paw', 'fa-solid fa-building-columns', 'fa-solid fa-cash-register', 'fa-solid fa-credit-card', 'fa-solid fa-hammer', 'fa-solid fa-music', 'fa-solid fa-camera', 'fa-solid fa-book-open', 'fa-solid fa-graduation-cap' ];
    
    let state = {
    currentUser: null, isAdmin: false, isGuest: false,
    services: [],
    businessHours: {},
    blockedDates: [],
    allAppointments: [], 
    users: [], // Lista de usuarios registrados
    myAppointments: [], 
    selectedService: null, currentDate: new Date(), selectedDate: null, selectedTime: null,
    editingServiceId: null,
    };

    // --- ELEMENTOS DEL DOM ---
    const viewContainer = document.getElementById('view-container');
    const mainNavContainer = document.getElementById('main-nav');
    const adminNavContainer = document.getElementById('admin-nav');
    const views = { login: document.getElementById('login-view'), services: document.getElementById('services-view'), calendar: document.getElementById('calendar-view'), confirmation: document.getElementById('confirmation-view'), myAppointments: document.getElementById('my-appointments-view'), admin: document.getElementById('admin-view'), };

    // --- INICIALIZACIÓN Y AUTENTICACIÓN ---
    function initializeAppState() {
    onAuthStateChanged(auth, async user => {
    if (user) {
    state.currentUser = user;
    // Lógica para determinar si es admin
    state.isAdmin = user.email === 'admin@admin.com'; // Simplificación, idealmente sería un rol en la DB
    
    await fetchDataFromDB();

    if (state.isAdmin) {
    showView('admin');
    renderAdminView();
    } else {
    showView('services', 'Elige un Servicio');
    renderServices();
    }
    } else {
    state.currentUser = null;
    state.isAdmin = false;
    showView('login');
    renderLogin();
    }
    });
    }
    
    async function fetchDataFromDB() {
    // Listen for services
    onSnapshot(collection(db, "services"), (snapshot) => {
    state.services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if(views.services.style.display !== 'none' && !state.isAdmin) renderServices();
    if(state.isAdmin && document.getElementById('services-table-container')) renderServicesTable();
    });

    // Listen for settings (hours and blocked dates)
    onSnapshot(doc(db, "settings", "main"), (doc) => {
    const settings = doc.data() || {};
    state.businessHours = settings.businessHours || { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 0: [] };
    state.blockedDates = settings.blockedDates || [];
    if(state.isAdmin && document.querySelector('.admin-tab-btn[data-tab="hours"]')) renderAdminHours();
    });

    // Listen for appointments
    onSnapshot(collection(db, "appointments"), (snapshot) => {
    state.allAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (state.currentUser) {
    state.myAppointments = state.allAppointments.filter(app => app.customer.uid === state.currentUser.uid);
    }
    if(state.isAdmin && document.querySelector('.admin-tab-btn[data-tab="agenda"]')) renderAdminAgenda();
    });

    // Fetch users for admin panel
    if (state.isAdmin) {
    const querySnapshot = await getDocs(collection(db, "users"));
    state.users = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if(document.querySelector('.admin-tab-btn[data-tab="users"]')) renderAdminUsers();
    }
    }

    // --- LÓGICA DE NAVEGACIÓN Y RENDERIZADO ---
    function showView(viewName, title = '', subtitle = '') {
  // Ocultar todas las views
  Object.values(views).forEach(view => view.classList.add('hidden'));
  mainNavContainer.classList.add('hidden');
  adminNavContainer.classList.add('hidden');

  // 🔹 Asegurar que modales no interfieran
  document.getElementById('icon-picker-modal').classList.add('hidden');
  document.getElementById('confirm-modal').classList.add('hidden');

  if (viewName === 'login') {
    viewContainer.classList.add('justify-center');
    viewContainer.parentElement.insertBefore(mainNavContainer, viewContainer);
  } else {
    viewContainer.classList.remove('justify-center');
    if (state.isAdmin) {
      adminNavContainer.classList.remove('hidden');
      renderAdminNav(title);
    } else {
      mainNavContainer.classList.remove('hidden');
      renderMainNav(title, subtitle);
    }
  }

  // Mostrar la vista activa
  views[viewName].classList.remove('hidden');
  views[viewName].classList.add('fade-in');
}

    // --- RENDERIZADO DE COMPONENTES ---
    function renderLogin() {
    views.login.innerHTML = `
    <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
    <i class="fas fa-calendar-check text-5xl text-indigo-500 mb-4"></i>
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Bienvenido</h1>
    <p class="text-gray-500 mb-6">Gestiona tus citas de forma fácil y rápida.</p>
    <div class="space-y-3">
    <button id="guest-booking-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Reservar sin registrarse</button>
    <button id="login-form-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300">Acceder / Registrarse</button>
    </div>
    <div id="auth-form-container" class="hidden mt-4 text-left">
    <hr class="my-4">
    <div class="flex border-b mb-4"><button id="login-tab" class="flex-1 p-2 font-semibold border-b-2 border-indigo-500">Iniciar Sesión</button><button id="register-tab" class="flex-1 p-2 text-gray-500">Registrarse</button></div>
    <form id="login-form"><div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="login-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label><input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Acceder</button></form>
    <form id="register-form" class="hidden"><div class="mb-4"><label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="register-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-6"><label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label><input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Crear Cuenta</button></form>
    <p id="auth-error" class="text-red-500 text-sm mt-2"></p>
    </div>
    </div>`;
    document.getElementById('login-form-btn').addEventListener('click', () => document.getElementById('auth-form-container').classList.toggle('hidden'));
    document.getElementById('guest-booking-btn').addEventListener('click', handleGuestBooking);
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('register-form').addEventListener('submit', handleRegister);
    document.getElementById('login-tab').addEventListener('click', switchAuthTab);
    document.getElementById('register-tab').addEventListener('click', switchAuthTab);
    }
    
    // ... (resto de funciones render, handle, etc. adaptadas para usar Firebase)
    
    // --- ADAPTACIONES A FUNCIONES EXISTENTES ---
    
    async function handleLogin(e) { 
    e.preventDefault(); 
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const errorEl = document.getElementById('auth-error');
    try {
    errorEl.textContent = '';
    await signInWithEmailAndPassword(auth, email, password);
    // onAuthStateChanged se encargará del resto
    } catch (error) {
    console.error("Error signing in:", error);
    errorEl.textContent = 'Email o contraseña incorrectos.';
    }
    }
    
    async function handleRegister(e) {
    e.preventDefault();
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const errorEl = document.getElementById('auth-error');
    try {
    errorEl.textContent = '';
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    // Guardar info adicional del usuario en Firestore
    await setDoc(doc(db, "users", userCredential.user.uid), {
    email: userCredential.user.email,
    createdAt: new Date()
    });
    } catch (error) {
    console.error("Error registering:", error);
    errorEl.textContent = 'Error al registrar. El email puede estar en uso.';
    }
    }

    function switchAuthTab(e) {
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    if (e.currentTarget.id === 'login-tab') {
    loginTab.classList.add('border-indigo-500');
    loginTab.classList.remove('text-gray-500');
    registerTab.classList.remove('border-indigo-500');
    registerTab.classList.add('text-gray-500');
    loginForm.classList.remove('hidden');
    registerForm.classList.add('hidden');
    } else {
    registerTab.classList.add('border-indigo-500');
    registerTab.classList.remove('text-gray-500');
    loginTab.classList.remove('border-indigo-500');
    loginTab.classList.add('text-gray-500');
    registerForm.classList.remove('hidden');
    loginForm.classList.add('hidden');
    }
    }

    function handleGuestBooking() { 
    state.isGuest = true; 
    state.currentUser = { name: 'Invitado', uid: 'guest-' + Date.now() }; 
    fetchDataFromDB(); // Cargar servicios, etc.
    showView('services', 'Elige un Servicio'); 
    renderServices();
    }
    
    async function handleLogout() {
    await signOut(auth);
    state = { ...state, currentUser: null, isAdmin: false, isGuest: false, myAppointments: [] };
    showView('login');
    renderLogin();
    }

    async function handleSaveService(e) {
    e.preventDefault();
    const form = e.target;
    const serviceData = {
    name: form['service-name'].value,
    description: form['service-desc'].value,
    duration: parseInt(form['service-duration'].value),
    icon: form['service-icon'].value
    };

    try {
    if (state.editingServiceId) {
    await setDoc(doc(db, "services", state.editingServiceId), serviceData);
    } else {
    await addDoc(collection(db, "services"), serviceData);
    }
    handleCancelEdit();
    } catch (error) {
    console.error("Error saving service: ", error);
    }
    }

    async function handleDeleteService(id) {
    showConfirmModal('Eliminar Servicio', '¿Estás seguro de que quieres eliminar este servicio?', async () => {
    try {
    await deleteDoc(doc(db, "services", id));
    } catch (error) {
    console.error("Error deleting service: ", error);
    }
    });
    }
    
    async function updateSettings() {
    try {
    await setDoc(doc(db, "settings", "main"), {
    businessHours: state.businessHours,
    blockedDates: state.blockedDates
    });
    } catch (error) {
    console.error("Error updating settings: ", error);
    }
    }

    function handleAddShift(day) { state.businessHours[day].push({ start: '09:00', end: '17:00' }); renderAdminHours(); updateSettings(); }
    function handleRemoveShift(day, shiftIndex) { state.businessHours[day].splice(shiftIndex, 1); renderAdminHours(); updateSettings(); }
    function handleShiftChange(input) { const { day, shift } = input.dataset; const type = input.classList.contains('shift-start') ? 'start' : 'end'; state.businessHours[day][shift][type] = input.value; updateSettings(); }
    function handleAddBlockDate() { const input = document.getElementById('block-date-input'); if (input.value && !state.blockedDates.includes(input.value)) { state.blockedDates.push(input.value); state.blockedDates.sort(); renderBlockedDatesList(); input.value = ''; updateSettings(); } }
    function handleRemoveBlockDate(date) { state.blockedDates = state.blockedDates.filter(d => d !== date); renderBlockedDatesList(); updateSettings(); }

    async function handleConfirmAppointment(e) {
    e.preventDefault();
    let customerData;
    const errorEl = document.getElementById('confirmation-error');
    errorEl.textContent = '';

    if (state.isGuest) {
    const name = document.getElementById('guest-name').value;
    const email = document.getElementById('guest-email').value;
    const phone = document.getElementById('guest-phone').value;
    if (!name || !email || !phone) {
    errorEl.textContent = 'Por favor, completa todos tus datos.';
    return;
    }
    customerData = { name, email, phone, uid: state.currentUser.uid };
    } else {
    customerData = { name: state.currentUser.email, email: state.currentUser.email, uid: state.currentUser.uid };
    }

    const newAppointment = {
    service: state.selectedService,
    date: state.selectedDate.toISOString(),
    time: state.selectedTime,
    customer: customerData
    };
    
    try {
    await addDoc(collection(db, "appointments"), newAppointment);
    state.myAppointments.push({ ...newAppointment, id: 'temp' }); // optimistic update
    showView('myAppointments', 'Cita Confirmada', 'Hemos añadido la cita a tu lista.');
    renderMyAppointments();
    } catch(error) {
    console.error("Error adding appointment: ", error);
    errorEl.textContent = 'No se pudo guardar la cita. Inténtalo de nuevo.';
    }
    }
    
    async function handleCancelAppointment(appointmentId) {
    showConfirmModal('Cancelar Cita', '¿Estás seguro de que quieres cancelar esta cita?', async () => {
    try {
    await deleteDoc(doc(db, "appointments", appointmentId));
    } catch (error) {
    console.error("Error deleting appointment:", error);
    }
    });
    }

    // --- Funciones de renderizado (con pequeños ajustes) ---
    function renderConfirmation() {
    const { selectedService, selectedDate, selectedTime } = state;
    const formattedDate = selectedDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    let guestFields = '';
    if(state.isGuest) {
    guestFields = `<h3 class="text-lg font-bold text-left mb-3">Tus Datos</h3>
    <div class="mb-2"><input type="text" id="guest-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nombre completo" required></div>
    <div class="mb-2"><input type="email" id="guest-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Email" required></div>
    <div class="mb-4"><input type="tel" id="guest-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Teléfono" required></div>
    <hr class="my-4">`;
    }
    views.confirmation.innerHTML = `<div class="bg-white p-8 rounded-2xl shadow-lg"><i class="${selectedService.icon} text-5xl text-indigo-500 mb-4 text-center w-full"></i><h2 class="text-2xl font-bold text-gray-900 text-center">Resumen de la Cita</h2><p class="text-gray-500 mb-6 text-center">Por favor, revisa los detalles.</p><form id="confirmation-form"><div id="confirmation-error" class="text-red-600 font-semibold text-center mb-4"></div>${guestFields}<div class="bg-gray-50 rounded-lg p-4 text-left space-y-3 mb-6"><div><strong class="text-gray-600">Servicio:</strong> <span class="float-right">${selectedService.name}</span></div><div><strong class="text-gray-600">Fecha:</strong> <span class="float-right">${formattedDate}</span></div><div><strong class="text-gray-600">Hora:</strong> <span class="float-right">${selectedTime}</span></div><div><strong class="text-gray-600">Duración:</strong> <span class="float-right">${selectedService.duration} min</span></div></div><div class="flex gap-4"><button type="button" id="back-to-calendar-button" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300">Cambiar Fecha</button><button type="submit" id="confirm-appointment-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Confirmar Cita</button></div></form></div>`; 
    document.getElementById('confirmation-form').addEventListener('submit', handleConfirmAppointment); 
    document.getElementById('back-to-calendar-button').addEventListener('click', () => showView('calendar', 'Selecciona Fecha y Hora', `Servicio: ${state.selectedService.name}`)); 
    }

    function renderMyAppointments() { 
    let content = ''; 
    if (state.myAppointments.length === 0) { 
    content = `<div class="text-center bg-white p-12 rounded-2xl shadow-lg"><i class="fas fa-calendar-times text-5xl text-gray-400 mb-4"></i><h2 class="text-2xl font-bold text-gray-800">No tienes citas programadas</h2><p class="text-gray-500 mt-2 mb-6">Cuando reserves una cita, aparecerá aquí.</p><button id="book-new-appointment-button" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700">Reservar una Cita</button></div>`; 
    } else { 
    content = `<div class="space-y-4">`; 
    state.myAppointments.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(app => { 
    const formattedDate = new Date(app.date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); 
    content += `<div class="bg-white p-5 rounded-2xl shadow-md flex items-center justify-between"><div class="flex items-center"><div class="flex items-center justify-center bg-indigo-100 rounded-full w-12 h-12 mr-4"><i class="${app.service.icon} text-2xl text-indigo-600"></i></div><div><h3 class="font-bold text-lg text-gray-800">${app.service.name}</h3><p class="text-sm text-gray-500">${formattedDate} a las ${app.time}</p></div></div><button class="cancel-appointment-button text-red-500 hover:text-red-700 font-semibold py-2 px-3 rounded-lg hover:bg-red-50" data-appointment-id="${app.id}">Cancelar</button></div>`; 
    }); 
    content += `</div>`; 
    } 
    views.myAppointments.innerHTML = content; 
    if (state.myAppointments.length === 0) { 
    document.getElementById('book-new-appointment-button').addEventListener('click', () => showView('services', 'Elige un Servicio')); 
    } else { 
    document.querySelectorAll('.cancel-appointment-button').forEach(btn => btn.addEventListener('click', (e) => handleCancelAppointment(e.currentTarget.dataset.appointmentId))); 
    } 
    }

    function renderAdminView() {
  views.admin.innerHTML = `
    <h1 class="text-3xl font-bold text-gray-900 mb-6 w-full">Panel de Administración</h1>
    <div class="flex flex-col lg:flex-row gap-6 w-full">
      <div class="lg:w-1/5">
        <div class="bg-white p-4 rounded-2xl shadow-lg">
          <nav class="flex flex-row lg:flex-col gap-2">
            <button class="admin-tab-btn w-full text-left p-3 rounded-lg flex items-center" data-tab="agenda">
              <i class="fas fa-calendar-alt w-6 mr-2"></i>Agenda
            </button>
            <button class="admin-tab-btn w-full text-left p-3 rounded-lg flex items-center" data-tab="services">
              <i class="fas fa-concierge-bell w-6 mr-2"></i>Servicios
            </button>
            <button class="admin-tab-btn w-full text-left p-3 rounded-lg flex items-center" data-tab="hours">
              <i class="fas fa-clock w-6 mr-2"></i>Horarios
            </button>
            <button class="admin-tab-btn w-full text-left p-3 rounded-lg flex items-center" data-tab="users">
              <i class="fas fa-users w-6 mr-2"></i>Usuarios
            </button>
          </nav>
        </div>
      </div>
      <div class="lg:w-4/5">
        <div id="admin-tab-content-agenda" class="admin-tab-content hidden"></div>
        <div id="admin-tab-content-services" class="admin-tab-content hidden"></div>
        <div id="admin-tab-content-hours" class="admin-tab-content hidden"></div>
        <div id="admin-tab-content-users" class="admin-tab-content hidden"></div>
      </div>
    </div>`;

  // Renderizar contenidos iniciales (rellenarlos si hay datos en state)
  renderAdminAgenda();
  renderAdminServices();
  renderAdminHours();
  renderAdminUsers();

  // Eventos de tabs
  document.querySelectorAll('.admin-tab-btn').forEach(btn =>
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
      const tab = e.currentTarget.dataset.tab;
      e.currentTarget.classList.add('active');
      document.getElementById(`admin-tab-content-${tab}`).classList.remove('hidden');
    })
  );

  // 🔹 Seleccionar por defecto "Agenda" y asegurar que sea visible
  const firstTab = document.querySelector('.admin-tab-btn[data-tab="agenda"]');
  if (firstTab) firstTab.click();
}

    function renderAdminUsers() {
    let content = `<div class="bg-white p-8 rounded-2xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Usuarios Registrados</h2>`;
    if (state.users.length === 0) {
    content += `<p class="text-gray-500">No hay usuarios registrados.</p>`;
    } else {
    content += `<div class="space-y-2">`;
    state.users.forEach(user => {
    content += `<div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center"><p class="text-sm text-gray-600">${user.email}</p></div>`;
    });
    content += `</div>`;
    }
    content += `</div>`;
    document.getElementById('admin-tab-content-users').innerHTML = content;
    }
    
    // --- El resto de funciones (renderServices, renderAdminAgenda, etc.) son muy similares, pero ahora leen de `state` que es poblado por Firebase ---
    // (Código de funciones de renderizado y lógica de calendario omitido por brevedad, es el mismo que en la v0.6 pero adaptado para fechas de Firestore)
    // Pegando el resto de funciones necesarias...
    function renderMainNav(title, subtitle) { mainNavContainer.innerHTML = `<div class="flex justify-between items-center"><div><h1 class="text-2xl md:text-3xl font-bold text-gray-900">${title}</h1><p class="text-gray-500 mt-1">${subtitle}</p></div><div><button id="my-appointments-button" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-100 mr-2 ${state.isGuest ? 'hidden' : ''}">Mis Citas</button><button id="logout-button" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-100"><i class="fas fa-sign-out-alt md:mr-2"></i><span class="hidden md:inline">Salir</span></button></div></div>`; document.getElementById('my-appointments-button').addEventListener('click', () => { showView('myAppointments', 'Mis Citas', 'Aquí puedes ver y gestionar tus próximas citas.'); renderMyAppointments(); }); document.getElementById('logout-button').addEventListener('click', handleLogout); }
    function renderAdminNav(title) { adminNavContainer.innerHTML = `<div class="flex justify-between items-center"><div><h1 class="text-2xl md:text-3xl font-bold text-gray-900">${title}</h1></div><div><button id="admin-logout-button" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-100"><i class="fas fa-sign-out-alt md:mr-2"></i><span class="hidden md:inline">Cerrar Sesión</span></button></div></div>`; document.getElementById('admin-logout-button').addEventListener('click', handleLogout); }
    function renderServices() { let content = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`; state.services.forEach(service => { content += `<div class="bg-white p-6 rounded-2xl shadow-md cursor-pointer transition-all duration-300 card-hover" data-service-id="${service.id}"><div class="flex items-center justify-center bg-indigo-100 rounded-full w-16 h-16 mb-4"><i class="${service.icon} text-3xl text-indigo-600"></i></div><h3 class="text-xl font-bold text-gray-800 mb-2">${service.name}</h3><p class="text-gray-500 text-sm mb-3">${service.description}</p><div class="text-xs font-medium text-gray-400"><i class="far fa-clock mr-1"></i> ${service.duration} minutos</div></div>`; }); content += `</div>`; views.services.innerHTML = content; document.querySelectorAll('[data-service-id]').forEach(card => card.addEventListener('click', () => handleSelectService(card.dataset.serviceId))); }
    function renderAdminAgenda() { let content = `<div class="bg-white p-8 rounded-2xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Próximas Citas</h2>`; if (state.allAppointments.length === 0) { content += `<p class="text-gray-500">No hay citas programadas.</p>`; } else { const groupedAppointments = state.allAppointments.reduce((acc, app) => { const date = new Date(app.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); if (!acc[date]) acc[date] = []; acc[date].push(app); return acc; }, {}); Object.keys(groupedAppointments).sort((a,b) => new Date(a) - new Date(b)).forEach(date => { content += `<h3 class="font-bold text-lg mt-6 mb-2 border-b pb-2">${date}</h3><div class="space-y-3">`; groupedAppointments[date].sort((a, b) => a.time.localeCompare(b.time)).forEach(app => { content += `<div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center"><div><span class="font-bold text-indigo-600">${app.time}</span> - ${app.service.name}</div><div class="text-sm text-gray-600">${app.customer.name} (${app.customer.email})</div></div>`; }); content += `</div>`; }); } content += `</div>`; document.getElementById('admin-tab-content-agenda').innerHTML = content; }
    function renderAdminServices() { document.getElementById('admin-tab-content-services').innerHTML = `<div class="grid grid-cols-1 xl:grid-cols-3 gap-6"><div class="xl:col-span-2 bg-white p-8 rounded-2xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Lista de Servicios</h2><div id="services-table-container" class="overflow-x-auto"></div></div><div class="bg-white p-8 rounded-2xl shadow-lg"><h2 id="service-form-title" class="text-2xl font-bold mb-4">Añadir Servicio</h2><form id="service-form"><input type="hidden" id="service-id"><div class="mb-4"><label for="service-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label><input type="text" id="service-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="service-desc" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label><textarea id="service-desc" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="3" required></textarea></div><div class="mb-4"><label for="service-duration" class="block text-sm font-medium text-gray-700 mb-1">Duración (min)</label><input type="number" id="service-duration" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Icono</label><div class="flex items-center gap-2"><input type="text" id="service-icon" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="ej: fa-solid fa-tooth" required readonly><button type="button" id="open-icon-picker" class="p-2 border rounded-lg"><i id="icon-preview" class="fas fa-icons"></i></button></div></div><div class="flex gap-4"><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Guardar</button><button type="button" id="cancel-edit-button" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 hidden">Cancelar</button></div></form></div></div>`; renderServicesTable(); document.getElementById('service-form').addEventListener('submit', handleSaveService); document.getElementById('cancel-edit-button').addEventListener('click', handleCancelEdit); document.getElementById('open-icon-picker').addEventListener('click', handleOpenIconPicker); document.getElementById('service-icon').addEventListener('click', handleOpenIconPicker); }
    function renderServicesTable() { const container = document.getElementById('services-table-container'); let table = `<table class="w-full text-left"><thead><tr><th class="p-2">Nombre</th><th class="p-2">Duración</th><th class="p-2">Acciones</th></tr></thead><tbody>`; state.services.forEach(s => { table += `<tr class="border-t"><td class="p-2 font-semibold flex items-center"><i class="${s.icon} w-6 mr-3 text-indigo-600"></i> ${s.name}</td><td class="p-2">${s.duration} min</td><td class="p-2"><button class="edit-service-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${s.id}"><i class="fas fa-edit"></i></button><button class="delete-service-btn text-red-500 hover:text-red-700" data-id="${s.id}"><i class="fas fa-trash"></i></button></td></tr>`; }); table += `</tbody></table>`; container.innerHTML = table; document.querySelectorAll('.edit-service-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditService(e.currentTarget.dataset.id))); document.querySelectorAll('.delete-service-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteService(e.currentTarget.dataset.id))); }
    function renderAdminHours() { const days = { 1: "Lunes", 2: "Martes", 3: "Miércoles", 4: "Jueves", 5: "Viernes", 6: "Sábado", 0: "Domingo" }; const dayOrder = [1, 2, 3, 4, 5, 6, 0]; let hoursContent = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`; dayOrder.forEach(index => { const dayShifts = state.businessHours[index] || []; hoursContent += `<div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-lg mb-3">${days[index]}</h3><div id="shifts-${index}" class="space-y-2">${dayShifts.map((shift, shiftIndex) => `<div class="flex items-center gap-2"><input type="time" value="${shift.start}" class="shift-start w-full border-gray-300 rounded-md" data-day="${index}" data-shift="${shiftIndex}"><span>-</span><input type="time" value="${shift.end}" class="shift-end w-full border-gray-300 rounded-md" data-day="${index}" data-shift="${shiftIndex}"><button class="remove-shift-btn text-red-500 hover:text-red-700" data-day="${index}" data-shift="${shiftIndex}">&times;</button></div>`).join('')}</div><button class="add-shift-btn mt-3 text-sm text-indigo-600 font-semibold" data-day="${index}">+ Añadir turno</button></div>`; }); hoursContent += `</div><div class="mt-6 bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-lg mb-3">Bloquear Fechas</h3><div class="flex items-center gap-2"><div class="relative w-full"><i class="fas fa-calendar-alt absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="date" id="block-date-input" class="w-full border-gray-300 rounded-md pl-10"></div><button id="add-block-date-btn" class="bg-gray-800 text-white font-semibold px-4 py-2 rounded-md hover:bg-black">Bloquear</button></div><div id="blocked-dates-list" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-2"></div></div>`; document.getElementById('admin-tab-content-hours').innerHTML = hoursContent; renderBlockedDatesList(); document.querySelectorAll('.add-shift-btn').forEach(btn => btn.addEventListener('click', (e) => handleAddShift(e.currentTarget.dataset.day))); document.querySelectorAll('.remove-shift-btn').forEach(btn => btn.addEventListener('click', (e) => handleRemoveShift(e.currentTarget.dataset.day, e.currentTarget.dataset.shift))); document.querySelectorAll('.shift-start, .shift-end').forEach(input => input.addEventListener('change', (e) => handleShiftChange(e.currentTarget))); document.getElementById('add-block-date-btn').addEventListener('click', handleAddBlockDate); }
    function renderBlockedDatesList() { const listEl = document.getElementById('blocked-dates-list'); listEl.innerHTML = state.blockedDates.map(date => `<div class="flex justify-between items-center bg-red-100 text-red-800 text-sm font-semibold p-2 rounded"><span>${date}</span><button class="remove-block-date-btn text-red-600 hover:text-red-800" data-date="${date}">&times;</button></div>`).join(''); document.querySelectorAll('.remove-block-date-btn').forEach(btn => btn.addEventListener('click', (e) => handleRemoveBlockDate(e.currentTarget.dataset.date))); }
    function handleEditService(id) { const service = state.services.find(s => s.id == id); if (!service) return; state.editingServiceId = service.id; document.getElementById('service-form-title').textContent = 'Editar Servicio'; document.getElementById('service-name').value = service.name; document.getElementById('service-desc').value = service.description; document.getElementById('service-duration').value = service.duration; document.getElementById('service-icon').value = service.icon; document.getElementById('icon-preview').className = service.icon; document.getElementById('cancel-edit-button').classList.remove('hidden'); }
    function handleCancelEdit() { state.editingServiceId = null; document.getElementById('service-form-title').textContent = 'Añadir Servicio'; document.getElementById('service-form').reset(); document.getElementById('icon-preview').className = 'fas fa-icons'; document.getElementById('cancel-edit-button').classList.add('hidden'); }
    function handleOpenIconPicker() { const modal = document.getElementById('icon-picker-modal'); const grid = document.getElementById('icon-picker-grid'); grid.innerHTML = PREDEFINED_ICONS.map(icon => `<button class="p-4 text-2xl rounded-lg hover:bg-gray-100" data-icon="${icon}"><i class="${icon}"></i></button>`).join(''); modal.classList.remove('hidden'); document.querySelectorAll('#icon-picker-grid button').forEach(btn => btn.addEventListener('click', (e) => { const icon = e.currentTarget.dataset.icon; document.getElementById('service-icon').value = icon; document.getElementById('icon-preview').className = icon; modal.classList.add('hidden'); })); document.getElementById('close-icon-modal').onclick = () => modal.classList.add('hidden'); }
    function generateAvailableSlotsForMonth(year, month, serviceDuration) { const slots = {}; const daysInMonth = new Date(year, month + 1, 0).getDate(); const today = new Date(); today.setHours(0, 0, 0, 0); for (let day = 1; day <= daysInMonth; day++) { const currentDate = new Date(year, month, day); const dayOfWeek = currentDate.getDay(); const dateKeyISO = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`; if (currentDate < today || state.blockedDates.includes(dateKeyISO)) continue; const daySlots = []; const workIntervals = state.businessHours[dayOfWeek]; if (!workIntervals || workIntervals.length === 0) continue; const appointmentsOnDay = state.allAppointments.filter(app => new Date(app.date).toDateString() === currentDate.toDateString()).map(app => app.time); workIntervals.forEach(interval => { let currentMin = timeToMinutes(interval.start); const endMin = timeToMinutes(interval.end); while (currentMin + serviceDuration <= endMin) { const slotTime = minutesToTime(currentMin); if (!appointmentsOnDay.includes(slotTime)) daySlots.push(slotTime); currentMin += 15; } }); if (daySlots.length > 0) slots[dateKeyISO] = daySlots; } state.availableSlots = slots; }
    function refreshCalendarView() { if (!state.selectedService) return; generateAvailableSlotsForMonth(state.currentDate.getFullYear(), state.currentDate.getMonth(), state.selectedService.duration); renderCalendar(); }
    function handleSelectService(serviceId) { state.selectedService = state.services.find(s => s.id == serviceId); showView('calendar', 'Selecciona Fecha y Hora', `Servicio: ${state.selectedService.name}`); refreshCalendarView(); }
    function handlePrevMonth() { state.currentDate.setMonth(state.currentDate.getMonth() - 1); refreshCalendarView(); }
    function handleNextMonth() { state.currentDate.setMonth(state.currentDate.getMonth() + 1); refreshCalendarView(); }
    function renderCalendar() { const year = state.currentDate.getFullYear(); const month = state.currentDate.getMonth(); const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]; const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); let calendarGrid = ''; ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].forEach(day => { calendarGrid += `<div class="font-bold text-center text-gray-500 text-sm">${day}</div>`; }); let startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; for (let i = 0; i < startDay; i++) { calendarGrid += '<div></div>'; } for (let day = 1; day <= daysInMonth; day++) { const dateKey = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`; const isAvailable = state.availableSlots[dateKey] && state.availableSlots[dateKey].length > 0; let dayClasses = 'calendar-day h-12 flex items-center justify-center rounded-lg'; if (!isAvailable) { dayClasses += ' disabled'; } else { dayClasses += ' available'; } calendarGrid += `<div class="${dayClasses}" data-day="${day}">${day}</div>`; } views.calendar.innerHTML = `<div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg"><div class="flex items-center justify-between mb-6"><button id="prev-month" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button><h2 class="text-2xl font-bold text-gray-800">${monthNames[month]} ${year}</h2><button id="next-month" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-2 mb-6">${calendarGrid}</div><div id="time-slots-container"></div></div><div class="mt-6 text-right"><button id="back-to-services" class="bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-100"><i class="fas fa-arrow-left mr-2"></i>Volver a Servicios</button></div>`; document.getElementById('prev-month').addEventListener('click', handlePrevMonth); document.getElementById('next-month').addEventListener('click', handleNextMonth); document.getElementById('back-to-services').addEventListener('click', () => showView('services', 'Elige un Servicio')); document.querySelectorAll('.calendar-day.available').forEach(dayEl => dayEl.addEventListener('click', () => handleSelectDay(dayEl))); }
    function handleSelectDay(dayEl) { document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected')); dayEl.classList.add('selected'); const day = parseInt(dayEl.dataset.day); state.selectedDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day); renderTimeSlots(state.selectedDate); }
    function renderTimeSlots(date) { const container = document.getElementById('time-slots-container'); const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; const slots = state.availableSlots[dateKey] || []; if (slots.length === 0) { container.innerHTML = ''; return; } let slotsHtml = `<h3 class="text-lg font-bold text-center mb-4 border-t pt-4">Hora</h3><div class="grid grid-cols-3 sm:grid-cols-4 gap-3">`; slots.forEach(slot => { slotsHtml += `<button class="time-slot bg-gray-100 text-gray-700 font-semibold py-3 rounded-lg hover:bg-indigo-100 hover:text-indigo-600" data-time="${slot}">${slot}</button>`; }); slotsHtml += `</div>`; container.innerHTML = slotsHtml; document.querySelectorAll('.time-slot').forEach(slotEl => slotEl.addEventListener('click', () => handleSelectTime(slotEl))); }
    function handleSelectTime(timeEl) { state.selectedTime = timeEl.dataset.time; showView('confirmation', 'Confirma tu Cita'); renderConfirmation(); }
    function showConfirmModal(title, text, onConfirm) { const modal = document.getElementById('confirm-modal'); document.getElementById('confirm-modal-title').textContent = title; document.getElementById('confirm-modal-text').textContent = text; modal.classList.remove('hidden'); const okButton = document.getElementById('confirm-modal-ok'); const cancelButton = document.getElementById('confirm-modal-cancel'); const confirmHandler = () => { onConfirm(); hide(); }; const hide = () => { modal.classList.add('hidden'); okButton.removeEventListener('click', confirmHandler); cancelButton.removeEventListener('click', hide); }; okButton.addEventListener('click', confirmHandler); cancelButton.addEventListener('click', hide); }
    function timeToMinutes(time) { const [h, m] = time.split(':').map(Number); return h * 60 + m; }
    function minutesToTime(minutes) { return `${Math.floor(minutes/60).toString().padStart(2,'0')}:${(minutes%60).toString().padStart(2,'0')}`; }
    </script>
</body>
</html>